#!/usr/bin/env ruby

$:.unshift(File.dirname(__FILE__) + '/../lib')

require 'smith'
require 'trollop'

parser = Trollop::Parser.new do
  banner "usage: #{$0} OPTIONS <queue>"

  opt :number,    "the number of payloads to pop off the queue", :type => :integer, :default => 0
  opt :print,     "print the payload"
end

opts = Trollop::with_standard_exception_handling parser do
  raise Trollop::HelpNeeded if ARGV.size < 1
  parser.parse ARGV
end

queue_name = ARGV[0]
payload = ARGV[1]

Smith.start do

  queue = Smith::Messaging.new(queue_name)

  work = proc do |n, iter|
    queue.pop do |payload|
      pp payload if payload && opts[:print]
      iter.next
    end
  end

  done = proc do
    Smith.stop(true)
  end

  EM::Iterator.new(0..opts[:number] - 1).each(work, done)
end
