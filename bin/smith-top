#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

$:.unshift(File.dirname(__FILE__) + '/../lib')

require 'pp'
require 'smith'

def format_queues(queue_stats)
  queue_stats.inject([]) do |a,queue_stat|
    a.tap do |acc|
      acc << "#{queue_stat.name}:[#{queue_stat.length}]"
    end
  end.join(";")
end

Smith.start do
  $: << Smith.pb_cache_path

  Smith::Messaging::Receiver.new('agent.stats', :durable => false, :auto_delete => false).ready do |receiver|
    receiver.subscribe do |metadata,payload|
      puts "#{payload.pid}\t#{payload.agent_name}\t#{payload.rss}MB\t#{payload.up_time}\t #{format_queues(payload.queues)}"
    end
  end
end
