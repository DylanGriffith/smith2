#!/usr/bin/env ruby

require 'pp'
require 'amqp'

EM.run do
  AMQP.connect do |connection|
    AMQP::Channel.new(connection) do |channel|

      host = ARGV[0]
      exchange = channel.topic("smith.exchange", :durable => true)

      channel.queue("", :auto_delete => true).bind(exchange, :routing_key => "smith.agency.controller.#{host}").subscribe do |metadata, payload|
        puts "    #{metadata.routing_key}"
      end

      channel.queue("", :auto_delete => true).bind(exchange, :routing_key => "smith.agency.controller.all").subscribe do |metadata, payload|
        puts "all #{metadata.routing_key}"
      end
    end
  end
end
