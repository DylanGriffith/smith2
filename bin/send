#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

$:.unshift(File.dirname(__FILE__) + '/../lib')

require 'smith'
require 'trollop'

parser = Trollop::Parser.new do
  banner "usage: #{$0} OPTIONS <queue> <payload>"

  opt :number,    "the number of times to send the message", :type => :integer, :default => 1, :short => :n
  opt :dynamic,   "send message to a dynamic queue", :type => :boolean, :default => false, :short => :d
end

opts = Trollop::with_standard_exception_handling parser do
  raise Trollop::HelpNeeded if ARGV.size < 2
  parser.parse ARGV
end

queue_name = ARGV[0]
payload = ARGV[1]

Smith.start do
  Smith::Messaging::Sender.new(queue_name, :auto_delete => opts[:dynamic]).ready do |s|
    work = proc do |n,iter|
      s.publish(Smith::ACL::Payload.new.content(payload), :persistent => true, :nowait => false) do
        iter.next
      end
    end

    done = proc do
      Smith.stop(true)
    end

    EM::Iterator.new(0..opts[:number] - 1).each(work, done)
  end
end
