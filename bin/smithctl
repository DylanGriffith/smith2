#!/usr/bin/env ruby

$:.unshift(File.dirname(__FILE__) + '/../lib')

require 'smith'

module Smith
  class SmithControl
    def initialize
      @queue = Messaging.new('agency.control')
    end

    def send_command(*args, &blk)
      payload = {:command => args.shift, :args => args.shift}

      sender = proc { |queue| queue.send_message(payload, :persistent => true, :nowait => false, &blk) }
      error = proc { puts "Agency not running"; Smith.stop(true) }
      @queue.consumers?(sender, error)
    end
  end
end

command = ARGV.shift
args = ARGV

command || (puts "usage #{File.basename($0)} <command> opts]"; exit 2)

Smith.start do
  control = Smith::SmithControl.new
  control.send_command(command, args) { Smith.stop(true) }
end
